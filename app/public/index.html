<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>app-web</title>
    <style>
        html,
        body {
            margin: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #050505;
            overscroll-behavior: none;
        }

        body {
            position: fixed;
            inset: 0;
        }

        #display {
            position: fixed;
            inset: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #050505;
        }

        #display canvas {
            display: block;
            max-width: 100%;
            max-height: 100%;
            outline: none;
            background: #050505;
        }

        #status {
            position: fixed;
            left: 50%;
            bottom: 16px;
            transform: translateX(-50%);
            z-index: 20;
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(10, 12, 16, 0.74);
            color: #f5f7fa;
            font: 500 12px/1.2 "Segoe UI", sans-serif;
            backdrop-filter: blur(10px);
            transition: opacity 180ms ease;
        }

        #status.is-hidden {
            opacity: 0;
        }
    </style>
</head>
<body>
    <div id="display"></div>
    <div id="status">Loading</div>

    <script type="module" crossorigin="anonymous">
        import RFB from './core/rfb.js';

        let rfb;
        let desktopName = "";
        let reconnectTimer = 0;

        const display = document.getElementById("display");
        const statusElement = document.getElementById("status");

        function setStatus(text, autoHide = false) {
            statusElement.textContent = text;
            statusElement.classList.remove("is-hidden");
            if (reconnectTimer) {
                clearTimeout(reconnectTimer);
                reconnectTimer = 0;
            }
            if (autoHide) {
                reconnectTimer = window.setTimeout(() => {
                    statusElement.classList.add("is-hidden");
                }, 1600);
            }
        }

        function readQueryVariable(name, defaultValue) {
            const re = new RegExp('.*[?&]' + name + '=([^&#]*)');
            const match = document.location.href.match(re);

            if (match) {
                return decodeURIComponent(match[1]);
            }

            return defaultValue;
        }

        function readBooleanQuery(name, defaultValue) {
            const fallback = defaultValue ? "1" : "0";
            const value = String(readQueryVariable(name, fallback)).trim().toLowerCase();
            return !["0", "false", "no", "off", ""].includes(value);
        }

        function readNumberQuery(name, defaultValue) {
            const parsed = Number.parseInt(readQueryVariable(name, String(defaultValue)), 10);
            return Number.isFinite(parsed) ? parsed : defaultValue;
        }

        function defaultWebsockifyPath() {
            const pathname = window.location.pathname.replace(/\/+$/, "");
            if (pathname === "") {
                return "websockify";
            }
            return pathname.replace(/^\//, "") + "/websockify";
        }

        function focusCanvas() {
            const canvas = document.querySelector("#display canvas");
            if (canvas) {
                canvas.tabIndex = 0;
                canvas.focus({ preventScroll: true });
            }
        }

        function reconnectSoon() {
            window.setTimeout(() => {
                window.location.reload();
            }, readNumberQuery("reconnect_delay", 1000));
        }

        function connectedToServer() {
            const label = desktopName ? `Connected to ${desktopName}` : "Connected";
            setStatus(label, true);
            focusCanvas();
        }

        function disconnectedFromServer() {
            setStatus("Connection lost. Reconnecting...");
            reconnectSoon();
        }

        function credentialsAreRequired() {
            const password = prompt("Password Required:");
            rfb.sendCredentials({ password });
        }

        function updateDesktopName(e) {
            desktopName = e.detail.name || "";
            document.title = desktopName || readQueryVariable("title", "app-web");
        }

        window.addEventListener("error", () => {
            reconnectSoon();
        }, true);

        const host = readQueryVariable("host", window.location.hostname);
        const port = readQueryVariable("port", window.location.port);
        const password = readQueryVariable("password");
        const path = readQueryVariable("path", defaultWebsockifyPath());

        let url = window.location.protocol === "https:" ? "wss" : "ws";
        url += "://" + host;
        if (port) {
            url += ":" + port;
        }
        url += "/" + path;

        setStatus("Connecting...");
        rfb = new RFB(display, url, { credentials: { password } });

        rfb.addEventListener("connect", connectedToServer);
        rfb.addEventListener("disconnect", disconnectedFromServer);
        rfb.addEventListener("credentialsrequired", credentialsAreRequired);
        rfb.addEventListener("desktopname", updateDesktopName);

        rfb.viewOnly = readBooleanQuery("view_only", false);
        rfb.scaleViewport = readBooleanQuery("scale", true);
        rfb.clipViewport = readBooleanQuery("clip", false);
        rfb.resizeSession = readBooleanQuery("resize", true);
        rfb.qualityLevel = readNumberQuery("quality", 9);
        rfb.compressionLevel = readNumberQuery("compression", 1);
        rfb.showDotCursor = true;
        rfb.dragViewport = false;
        rfb.focusOnClick = true;
        document.title = readQueryVariable("title", "app-web");

        window.addEventListener("resize", focusCanvas);
        window.setInterval(focusCanvas, 250);
    </script>
</body>
</html>
